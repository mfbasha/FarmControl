(function(){"use strict";var a;a=jQuery,window.EDD_Jilt=function(){function b(){var b;this.params=window.edd_jilt_params,this.params.order_id&&(b=a(document.body),b.on("focusin","input, select",function(a){return function(b){return a.persist_order_data(b)}}(this)),b.on("focusout","input, select",function(a){return function(b){return a.send_order_data(b)}}(this)),a(window).on("unload visibilitychange",function(a){return function(){return a.send_order_data_before_unload()}}(this)))}return b.prototype.persist_order_data=function(b){var c;if(c=a(b.target),this.is_checkout_field(c))return c.val()?c.attr("data-jilt-value",c.val()):void 0},b.prototype.send_order_data=function(b){var c,d,e,f,g;if(c=a(b.target),g=c.val(),null!=(f=c.attr("name"))&&this.is_checkout_field(c)&&g&&g!==c.attr("data-jilt-value")&&("edd_email"!==f||this.is_valid_email(g))&&null!=(e=this.params.payment_field_mapping[f]))return d={},d.cart_token=this.params.cart_token,d.billing_address={},d.billing_address[e]=g,["email","first_name","last_name"].indexOf(e)>-1&&(d.customer={},d.customer[e]=g),a.ajax({method:"PUT",url:this.params.endpoint+"/orders/"+this.params.order_id,headers:{Authorization:"Token "+this.params.public_key,"x-jilt-shop-domain":this.params.x_jilt_shop_domain},data:d})},b.prototype.send_order_data_before_unload=function(){var b,c,d,e,f,g,h;h=this.params.endpoint+"/orders/"+this.params.order_id,c={},c.cart_token=this.params.cart_token,c.customer={},c.billing_address={},c.shipping_address={},f=this.params.order_address_mapping;for(d in f)e=f[d],b=a("input[name=billing_"+d+"]").val(),g=a("input[name=shipping_"+d+"]").val(),("email"!==d||this.is_valid_email(b))&&(b&&(c.billing_address[e]=b,["email","first_name","last_name"].indexOf(e)>-1&&(c.customer[e]=b)),g&&(c.shipping_address[e]=g));if(!(a.isEmptyObject(c.customer)&&a.isEmptyObject(c.billing_address)&&a.isEmptyObject(c.shipping_address)))return null!=navigator.sendBeacon?(c.auth_token=this.params.public_key,navigator.sendBeacon(h+"/beacon",new Blob([a.param(c)],{type:"application/x-www-form-urlencoded"}))):a.ajax({method:"PUT",url:h,headers:{Authorization:"Token "+this.params.public_key,"x-jilt-shop-domain":this.params.x_jilt_shop_domain},data:c,async:!1,timeout:750})},b.prototype.is_checkout_field=function(a){var b;return null!=(b=a.attr("name"))&&-1!==b.indexOf("edd_")},b.prototype.is_valid_email=function(a){return/[^\s@]+@[^\s@]+\.[^\s@]+/.test(a)},b.prototype.set_customer=function(b){return a.ajax({method:"POST",url:this.params.ajax_url,data:{action:"edd_jilt_set_customer",_ajax_nonce:this.params.nonce,email:b.email,first_name:b.first_name,last_name:b.last_name},success:function(a){return function(b){if(a.params.log_threshold<=100)return console.log(b)}}(this),failure:function(a){return function(b){if(a.params.log_threshold<=100)return console.log(b)}}(this)})},b}(),window.edd_jilt=new EDD_Jilt}).call(this);
